<!doctype html><html class=theme-light lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A guide to writing new rc.d scripts and understanding those already written"><meta name=keywords content="rc.d,scripting,guide,tutorial,FreeBSD"><meta name=copyright content="1995-2024 The FreeBSD Foundation"><link rel=canonical href=https://docs.freebsd.org/en/articles/rc-scripting/><title>Practical rc.d scripting in BSD | FreeBSD Documentation Portal</title>
<meta name=theme-color content="#790000"><meta name=color-scheme content="system light dark high-contrast"><link rel="shortcut icon" href=https://docs.freebsd.org/favicon.ico><link rel=stylesheet href=https://docs.freebsd.org/styles/main.min.css><link rel=stylesheet href=https://docs.freebsd.org/css/font-awesome-min.css><script defer src=/js/theme-chooser.min.js></script><script defer src=/js/copy-clipboard.min.js></script><script defer src=/js/search.min.js></script><meta name=twitter:card content="summary"><meta name=twitter:domain content="docs.FreeBSD.org"><meta name=twitter:site content="@freebsd"><meta name=twitter:url content="https://twitter.com/freebsd"><meta property="og:title" content="Practical rc.d scripting in BSD"><meta property="og:description" content="A guide to writing new rc.d scripts and understanding those already written"><meta property="og:type" content="website"><meta property="og:image" content="https://docs.freebsd.org/favicon.ico"><meta property="og:image:alt" content="FreeBSD Logo"><meta property="og:locale" content="en"><meta property="og:url" content="https://docs.freebsd.org/en/articles/rc-scripting/"><meta property="og:site_name" content="FreeBSD Documentation Portal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","url":"https:\/\/docs.freebsd.org\/en\/articles\/rc-scripting\/","name":"FreeBSD Documentation Portal","headline":"FreeBSD Documentation Portal","description":"FreeBSD Documentation Portal"}</script></head><body><header><div class=header-container><div class=logo-menu-bars-container><a href=https://www.FreeBSD.org class=logo><img src=https://docs.freebsd.org/images/FreeBSD-monochromatic.svg width=160 height=50 alt="FreeBSD logo">
</a><label class=menu-bars for=menu-bars><i class="fa fa-bars" aria-hidden=true></i></label></div><input id=menu-bars type=checkbox><nav><ul class=menu><li class=menu-item><input id=about type=checkbox>
<a href=# aria-label="Navigate to About section"><label class=menu-item-description for=about>About
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/about/ target=_blank>About</a></li><li><a href=https://www.freebsd.org/about/ target=_blank>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/about-us/about-the-foundation/ target=_blank>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct/ target=_blank>Code of Conduct</a></li></ul></li><li class=menu-item><input id=download type=checkbox>
<a href=# aria-label="Navigate to get FreeBSD section"><label class=menu-item-description for=download>Get FreeBSD
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/where/ target=_blank>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/releases/ target=_blank>Release Information</a></li><li><a href=https://www.freebsd.org/releng/ target=_blank>Release Engineering</a></li><li><a href=https://www.freebsd.org/security/ target=_blank>Security Advisories</a></li></ul></li><li class=menu-item><input id=documentation type=checkbox>
<a href=# aria-label="Navigate to get Documentation section"><label class=menu-item-description for=documentation>Documentation
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=/en>Documentation portal</a></li><li><a href=https://docs.freebsd.org/en/books/handbook>FreeBSD Handbook</a></li><li><a href=https://docs.freebsd.org/en/books/porters-handbook>Porter's Handbook</a></li><li><a href=https://docs.FreeBSD.org/en/books/fdp-primer>Documentation Project Handbook</a></li><li><a href=https://man.FreeBSD.org target=_blank>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank>Presentations and papers</a></li><li><a href=https://wiki.FreeBSD.org target=_blank>Wiki</a></li><li><a href=https://docs.freebsd.org/en/books>Books</a></li><li><a href=https://docs.freebsd.org/en/articles>Articles</a></li></ul></li><li class=menu-item><input id=community type=checkbox>
<a href=# aria-label="Navigate to get Community section"><label class=menu-item-description for=community>Community
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/community/>Community</a></li><li><a href=https://docs.freebsd.org/en/articles/contributing>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank>Forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank>Bug Tracker</a></li><li><a href=https://www.freebsd.org/support/ target=_blank>Support</a></li></ul></li></ul></nav><div class=search-donate-container><form class=search method=get id=search-header-form action=https://docs.freebsd.org/search name=search-header-form><input type=hidden name=DB value=en>
<input id=words name=P type=text size=20 maxlength=255>
<button>
<i class="fa fa-search" aria-hidden=true></i></button></form><div class=donate><a href=https://freebsdfoundation.org/donate/ target=_blank><span class=heart>♥</span>
Donate</a></div></div></div></header><main class=main-wrapper-article><div class=article><h1 class=title>Practical rc.d scripting in BSD</h1><div class=copyright>Copyright © 2005-2006, 2012 The FreeBSD Project</div><div class=legalnotice><a id=trademarks></a><details><summary>trademarks</summary><p>FreeBSD is a registered trademark of the FreeBSD Foundation.</p><p>NetBSD is a registered trademark of the NetBSD Foundation.</p><p>Many of the designations used by manufacturers and sellers to distinguish their products are claimed as trademarks. Where those designations appear in this document, and the FreeBSD Project was aware of the trademark claim, the designations have been followed by the “™” or the “®” symbol.</p></details></div><div class=toc-mobile><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#rcng-intro>1. Introduction</a></li><li><a href=#rcng-task>2. Outlining the task</a></li><li><a href=#rcng-dummy>3. A dummy script</a></li><li><a href=#rcng-confdummy>4. A configurable dummy script</a></li><li><a href=#rcng-daemon>5. Startup and shutdown of a simple daemon</a></li><li><a href=#rcng-daemon-adv>6. Startup and shutdown of an advanced daemon</a></li><li><a href=#rcng-hookup>7. Connecting a script to the rc.d framework</a></li><li><a href=#rcng-args>8. Giving more flexibility to an rc.d script</a></li><li><a href=#rcng-service-jails>9. Making a script ready for Service Jails</a></li><li><a href=#rcng-instancing>10. Advanced rc-scripting: Instancing</a></li><li><a href=#rcng-furthur>11. Further reading</a></li></ul></nav></div><div id=preamble><div class=sectionbody><div class="paragraph abstract-title"><p>Abstract</p></div><div class=paragraph><p>Beginners may find it difficult to relate the facts from the formal documentation on the BSD <span class=filename>rc.d</span> framework with the practical tasks of <span class=filename>rc.d</span> scripting.
In this article, we consider a few typical cases of increasing complexity, show <span class=filename>rc.d</span> features suited for each case, and discuss how they work.
Such an examination should provide reference points for further study of the design and efficient application of <span class=filename>rc.d</span>.</p></div><hr></div></div><div class=sect1><h2 id=rcng-intro>1. Introduction<a class=anchor href=#rcng-intro></a></h2><div class=sectionbody><div class=paragraph><p>The historical BSD had a monolithic startup script, <span class=filename>/etc/rc</span>.
It was invoked by <a href="https://man.freebsd.org/cgi/man.cgi?query=init&amp;sektion=8&amp;format=html">init(8)</a> at system boot time and performed all userland tasks required for multi-user operation: checking and mounting file systems, setting up the network, starting daemons, and so on.
The precise list of tasks was not the same in every system; admins needed to customize it.
With few exceptions, <span class=filename>/etc/rc</span> had to be modified, and true hackers liked it.</p></div><div class=paragraph><p>The real problem with the monolithic approach was that it provided no control over the individual components started from <span class=filename>/etc/rc</span>.
For instance, <span class=filename>/etc/rc</span> could not restart a single daemon.
The system admin had to find the daemon process by hand, kill it, wait until it actually exited, then browse through <span class=filename>/etc/rc</span> for the flags, and finally type the full command line to start the daemon again.
The task would become even more difficult and prone to errors if the service to restart consisted of more than one daemon or demanded additional actions.
In a few words, the single script failed to fulfil what scripts are for: to make the system admin’s life easier.</p></div><div class=paragraph><p>Later there was an attempt to split out some parts of <span class=filename>/etc/rc</span> for the sake of starting the most important subsystems separately.
The notorious example was <span class=filename>/etc/netstart</span> to bring up networking.
It did allow for accessing the network from single-user mode, but it did not integrate well into the automatic startup process because parts of its code needed to interleave with actions essentially unrelated to networking.
That was why <span class=filename>/etc/netstart</span> mutated into <span class=filename>/etc/rc.network</span>.
The latter was no longer an ordinary script; it comprised of large, tangled <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> functions called from <span class=filename>/etc/rc</span> at different stages of system startup.
However, as the startup tasks grew diverse and sophisticated, the "quasi-modular" approach became even more of a drag than the monolithic <span class=filename>/etc/rc</span> had been.</p></div><div class=paragraph><p>Without a clean and well-designed framework, the startup scripts had to bend over backwards to satisfy the needs of rapidly developing BSD-based operating systems.
It became obvious at last that more steps are necessary on the way to a fine-grained and extensible <span class=filename>rc</span> system.
Thus BSD <span class=filename>rc.d</span> was born.
Its acknowledged fathers were Luke Mewburn and the NetBSD community.
Later it was imported into FreeBSD.
Its name refers to the location of system scripts for individual services, which is in <span class=filename>/etc/rc.d</span>.
Soon we will learn about more components of the <span class=filename>rc.d</span> system and see how the individual scripts are invoked.</p></div><div class=paragraph><p>The basic ideas behind BSD <span class=filename>rc.d</span> are <em>fine modularity</em> and <em>code reuse</em>.
<em>Fine modularity</em> means that each basic "service" such as a system daemon or primitive startup task gets its own <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> script able to start the service, stop it, reload it, check its status.
A particular action is chosen by the command-line argument to the script.
The <span class=filename>/etc/rc</span> script still drives system startup, but now it merely invokes the smaller scripts one by one with the <code>start</code> argument.
It is easy to perform shutdown tasks as well by running the same set of scripts with the <code>stop</code> argument, which is done by <span class=filename>/etc/rc.shutdown</span>.
Note how closely this follows the Unix way of having a set of small specialized tools, each fulfilling its task as well as possible.
<em>Code reuse</em> means that common operations are implemented as <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> functions and collected in <span class=filename>/etc/rc.subr</span>.
Now a typical script can be just a few lines' worth of <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> code.
Finally, an important part of the <span class=filename>rc.d</span> framework is <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a>, which helps <span class=filename>/etc/rc</span> to run the small scripts orderly with respect to dependencies between them.
It can help <span class=filename>/etc/rc.shutdown</span>, too, because the proper order for the shutdown sequence is opposite to that of startup.</p></div><div class=paragraph><p>The BSD <span class=filename>rc.d</span> design is described in <a href=../rc-scripting/#lukem>the original article by Luke Mewburn</a>, and the <span class=filename>rc.d</span> components are documented in great detail in <a href=../rc-scripting/#manpages>the respective manual pages</a>.
However, it might not appear obvious to an <span class=filename>rc.d</span> newbie how to tie the numerous bits and pieces together to create a well-styled script for a particular task.
Therefore this article will try a different approach to describe <span class=filename>rc.d</span>.
It will show which features should be used in a number of typical cases, and why.
Note that this is not a how-to document because our aim is not at giving ready-made recipes, but at showing a few easy entrances into the <span class=filename>rc.d</span> realm.
Neither is this article a replacement for the relevant manual pages.
Do not hesitate to refer to them for more formal and complete documentation while reading this article.</p></div><div class=paragraph><p>There are prerequisites to understanding this article.
First of all, you should be familiar with the <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> scripting language to master <span class=filename>rc.d</span>.
In addition, you should know how the system performs userland startup and shutdown tasks, which is described in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a>.</p></div><div class=paragraph><p>This article focuses on the FreeBSD branch of <span class=filename>rc.d</span>.
Nevertheless, it may be useful to NetBSD developers, too, because the two branches of BSD <span class=filename>rc.d</span> not only share the same design but also stay similar in their aspects visible to script authors.</p></div></div></div><div class=sect1><h2 id=rcng-task>2. Outlining the task<a class=anchor href=#rcng-task></a></h2><div class=sectionbody><div class=paragraph><p>A little consideration before starting <code>$EDITOR</code> will not hurt.
To write a well-tempered <span class=filename>rc.d</span> script for a system service, we should be able to answer the following questions first:</p></div><div class=ulist><ul><li><p>Is the service mandatory or optional?</p></li><li><p>Will the script serve a single program, e.g., a daemon, or perform more complex actions?</p></li><li><p>Which other services will our service depend on, and vice versa?</p></li></ul></div><div class=paragraph><p>From the examples that follow we will see why it is important to know the answers to these questions.</p></div></div></div><div class=sect1><h2 id=rcng-dummy>3. A dummy script<a class=anchor href=#rcng-dummy></a></h2><div class=sectionbody><div class=paragraph><p>The following script just emits a message each time the system boots up:</p></div><div class="literalblock programlisting"><div class=content><pre>#!/bin/sh <i class=conum data-value=1></i><b>(1)</b>

. /etc/rc.subr <i class=conum data-value=2></i><b>(2)</b>

name=&#34;dummy&#34; <i class=conum data-value=3></i><b>(3)</b>
start_cmd=&#34;${name}_start&#34; <i class=conum data-value=4></i><b>(4)</b>
stop_cmd=&#34;:&#34; <i class=conum data-value=5></i><b>(5)</b>

dummy_start() <i class=conum data-value=6></i><b>(6)</b>
{
	echo &#34;Nothing started.&#34;
}

load_rc_config $name <i class=conum data-value=7></i><b>(7)</b>
run_rc_command &#34;$1&#34; <i class=conum data-value=8></i><b>(8)</b></pre></div></div><div class=paragraph><p>Things to note are:</p></div><div class=paragraph><p>➊ An interpreted script should begin with the magic "shebang" line.
That line specifies the interpreter program for the script.
Due to the shebang line, the script can be invoked exactly like a binary program provided that it has the execute bit set.
(See <a href="https://man.freebsd.org/cgi/man.cgi?query=chmod&amp;sektion=1&amp;format=html">chmod(1)</a>.)
For example, a system admin can run our script manually, from the command line:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># /etc/rc.d/dummy start</span></code></pre></div></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>To be properly managed by the <span class=filename>rc.d</span> framework, its scripts need to be written in the <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> language.
If you have a service or port that uses a binary control utility or a startup routine written in another language, install that element in <span class=filename>/usr/sbin</span> (for the system) or <span class=filename>/usr/local/sbin</span> (for ports) and call it from a <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> script in the appropriate <span class=filename>rc.d</span> directory.</p></div></td></tr></tbody></table></div><div class="admonitionblock tip"><table><tbody><tr><td class=icon><i class="fa icon-tip" title=Tip></i></td><td class=content><div class=paragraph><p>If you would like to learn the details of why <span class=filename>rc.d</span> scripts must be written in the <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> language, see how <span class=filename>/etc/rc</span> invokes them by means of <code>run_rc_script</code>, then study the implementation of <code>run_rc_script</code> in <span class=filename>/etc/rc.subr</span>.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➋ In <span class=filename>/etc/rc.subr</span>, a number of <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> functions are defined for an <span class=filename>rc.d</span> script to use.
The functions are documented in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>.
While it is theoretically possible to write an <span class=filename>rc.d</span> script without ever using <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>, its functions prove extremely handy and make the job an order of magnitude easier. So it is no surprise that everybody resorts to <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> in <span class=filename>rc.d</span> scripts.
We are not going to be an exception.</p></div><div class=paragraph><p>An <span class=filename>rc.d</span> script must "source"<span class=filename>/etc/rc.subr</span> (include it using “.”) <em>before</em> it calls <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> functions so that <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> has an opportunity to learn the functions.
The preferred style is to source <span class=filename>/etc/rc.subr</span> first of all.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Some useful functions related to networking are provided by another include file, <span class=filename>/etc/network.subr</span>.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➌ <a id=name-var></a>The mandatory variable <code>name</code> specifies the name of our script.
It is required by <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>.
That is, each <span class=filename>rc.d</span> script <em>must</em> set <code>name</code> before it calls <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> functions.</p></div><div class=paragraph><p>Now it is the right time to choose a unique name for our script once and for all.
We will use it in a number of places while developing the script.
The content of the name variable needs to match the script name,
some parts of FreeBSD (e.g., <a href=../rc-scripting/#rcng-service-jails>service jails</a> and the cpuset feature of the rc framework) depend upon this.
As such the filename shall also not contain characters which may be troublesome in scripting (e.g., do not use a hyphen "-" and others).</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>The current style of <span class=filename>rc.d</span> scripting is to enclose values assigned to variables in double quotes.
Keep in mind that it is just a style issue that may not always be applicable.
You can safely omit quotes from around simple words without <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> metacharacters in them, while in certain cases you will need single quotes to prevent any interpretation of the value by <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a>.
A programmer should be able to tell the language syntax from style conventions and use both of them wisely.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➍ The main idea behind <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> is that an <span class=filename>rc.d</span> script provides handlers, or methods, for <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> to invoke.
In particular, <code>start</code>, <code>stop</code>, and other arguments to an <span class=filename>rc.d</span> script are handled this way.
A method is a <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> expression stored in a variable named <code>argument_cmd</code>, where <em>argument</em> corresponds to what can be specified on the script’s command line.
We will see later how <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> provides default methods for the standard arguments.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>To make the code in <span class=filename>rc.d</span> more uniform, it is common to use <code>${name}</code> wherever appropriate.
Thus a number of lines can be just copied from one script to another.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➎ We should keep in mind that <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> provides default methods for the standard arguments.
Consequently, we must override a standard method with a no-op <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> expression if we want it to do nothing.</p></div><div class=paragraph><p>➏ The body of a sophisticated method can be implemented as a function.
It is a good idea to make the function name meaningful.</p></div><div class="admonitionblock important"><table><tbody><tr><td class=icon><i class="fa icon-important" title=Important></i></td><td class=content><div class=paragraph><p>It is strongly recommended to add the prefix <code>${name}</code> to the names of all functions defined in our script so they never clash with the functions from <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> or another common include file.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➐ This call to <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> loads <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variables.
Our script makes no use of them yet, but it still is recommended to load <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> because there can be <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variables controlling <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> itself.</p></div><div class=paragraph><p>➑ Usually this is the last command in an <span class=filename>rc.d</span> script.
It invokes the <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> machinery to perform the requested action using the variables and methods our script has provided.</p></div></div></div><div class=sect1><h2 id=rcng-confdummy>4. A configurable dummy script<a class=anchor href=#rcng-confdummy></a></h2><div class=sectionbody><div class=paragraph><p>Now let us add some controls to our dummy script.
As you may know, <span class=filename>rc.d</span> scripts are controlled with <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a>.
Fortunately, <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> hides all the complications from us.
The following script uses <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> via <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> to see whether it is enabled in the first place, and to fetch a message to show at boot time.
These two tasks in fact are independent.
On the one hand, an <span class=filename>rc.d</span> script can just support enabling and disabling its service.
On the other hand, a mandatory <span class=filename>rc.d</span> script can have configuration variables.
We will do both things in the same script though:</p></div><div class="literalblock programlisting"><div class=content><pre>#!/bin/sh

. /etc/rc.subr

name=dummy
rcvar=dummy_enable <i class=conum data-value=1></i><b>(1)</b>

start_cmd=&#34;${name}_start&#34;
stop_cmd=&#34;:&#34;

load_rc_config $name <i class=conum data-value=2></i><b>(2)</b>
: ${dummy_enable:=no} <i class=conum data-value=3></i><b>(3)</b>
: ${dummy_msg=&#34;Nothing started.&#34;} <i class=conum data-value=4></i><b>(4)</b>

dummy_start()
{
	echo &#34;$dummy_msg&#34; <i class=conum data-value=5></i><b>(5)</b>
}

run_rc_command &#34;$1&#34;</pre></div></div><div class=paragraph><p>What changed in this example?</p></div><div class=paragraph><p>➊ The variable <code>rcvar</code> specifies the name of the ON/OFF knob variable.</p></div><div class=paragraph><p>➋ Now <code>load_rc_config</code> is invoked earlier in the script, before any <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variables are accessed.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>While examining <span class=filename>rc.d</span> scripts, keep in mind that <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> defers the evaluation of expressions in a function until the latter is called.
Therefore it is not an error to invoke <code>load_rc_config</code> as late as just before <code>run_rc_command</code> and still access <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variables from the method functions exported to <code>run_rc_command</code>.
This is because the method functions are to be called by <code>run_rc_command</code>, which is invoked <em>after</em> <code>load_rc_config</code>.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➌ A warning will be emitted by <code>run_rc_command</code> if <code>rcvar</code> itself is set, but the indicated knob variable is unset.
If your <span class=filename>rc.d</span> script is for the base system, you should add a default setting for the knob to <span class=filename>/etc/defaults/rc.conf</span> and document it in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a>.
Otherwise it is your script that should provide a default setting for the knob.
The canonical approach to the latter case is shown in the example.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>You can make <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> act as though the knob is set to <code>ON</code>, irrespective of its current setting, by prefixing the argument to the script with <code>one</code> or <code>force</code>, as in <code>onestart</code> or <code>forcestop</code>.
Keep in mind though that <code>force</code> has other dangerous effects we will touch upon below, while <code>one</code> just overrides the ON/OFF knob.
E.g., assume that <code>dummy_enable</code> is <code>OFF</code>.
The following command will run the <code>start</code> method in spite of the setting:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># /etc/rc.d/dummy onestart</span></code></pre></div></div></td></tr></tbody></table></div><div class=paragraph><p>➍ Now the message to be shown at boot time is no longer hard-coded in the script.
It is specified by an <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variable named <code>dummy_msg</code>.
This is a trivial example of how <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variables can control an <span class=filename>rc.d</span> script.</p></div><div class="admonitionblock important"><table><tbody><tr><td class=icon><i class="fa icon-important" title=Important></i></td><td class=content><div class=paragraph><p>The names of all <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variables used exclusively by our script <em>must</em> have the same prefix: <code>${name}_</code>.
For example: <code>dummy_mode</code>, <code>dummy_state_file</code>, and so on.</p></div></td></tr></tbody></table></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>While it is possible to use a shorter name internally, e.g., just <code>msg</code>, adding the unique prefix <code>${name}_</code> to all global names introduced by our script will save us from possible collisions with the <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> namespace.</p></div><div class=paragraph><p>As a rule, <span class=filename>rc.d</span> scripts of the base system need not provide defaults for their <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variables because the defaults should be set in <span class=filename>/etc/defaults/rc.conf</span> instead.
On the other hand, <span class=filename>rc.d</span> scripts for ports should provide the defaults as shown in the example.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➎ Here we use <code>dummy_msg</code> to actually control our script, i.e., to emit a variable message.
Use of a shell function is overkill here, since it only runs a single command; an equally valid alternative is:</p></div><div class="literalblock programlisting"><div class=content><pre>start_cmd=&#34;echo \&#34;$dummy_msg\&#34;&#34;</pre></div></div></div></div><div class=sect1><h2 id=rcng-daemon>5. Startup and shutdown of a simple daemon<a class=anchor href=#rcng-daemon></a></h2><div class=sectionbody><div class=paragraph><p>We said earlier that <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> could provide default methods.
Obviously, such defaults cannot be too general.
They are suited for the common case of starting and shutting down a simple daemon program.
Let us assume now that we need to write an <span class=filename>rc.d</span> script for such a daemon called <code>mumbled</code>.
Here it is:</p></div><div class="literalblock programlisting"><div class=content><pre>#!/bin/sh

. /etc/rc.subr

name=mumbled
rcvar=mumbled_enable

command=&#34;/usr/sbin/${name}&#34; <i class=conum data-value=1></i><b>(1)</b>

load_rc_config $name
run_rc_command &#34;$1&#34;</pre></div></div><div class=paragraph><p>Pleasingly simple, isn’t it? Let us examine our little script.
The only new thing to note is as follows:</p></div><div class=paragraph><p>➊ The <code>command</code> variable is meaningful to <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>.
If it is set, <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> will act according to the scenario of serving a conventional daemon.
In particular, the default methods will be provided for such arguments: <code>start</code>, <code>stop</code>, <code>restart</code>, <code>poll</code>, and <code>status</code>.</p></div><div class=paragraph><p>The daemon will be started by running <code>$command</code> with command-line flags specified by <code>$mumbled_flags</code>.
Thus all the input data for the default <code>start</code> method are available in the variables set by our script.
Unlike <code>start</code>, other methods may require additional information about the process started.
For instance, <code>stop</code> must know the PID of the process to terminate it.
In the present case, <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> will scan through the list of all processes, looking for a process with its name equal to <code>procname</code>.
The latter is another variable of meaning to <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>, and its value defaults to that of <code>command</code>.
In other words, when we set <code>command</code>, <code>procname</code> is effectively set to the same value.
This enables our script to kill the daemon and to check if it is running in the first place.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Some programs are in fact executable scripts.
The system runs such a script by starting its interpreter and passing the name of the script to it as a command-line argument.
This is reflected in the list of processes, which can confuse <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>.
You should additionally set <code>command_interpreter</code> to let <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> know the actual name of the process if <code>$command</code> is a script.</p></div><div class=paragraph><p>For each <span class=filename>rc.d</span> script, there is an optional <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variable that takes precedence over <code>command</code>.
Its name is constructed as follows: <code>${name}_program</code>, where <code>name</code> is the
mandatory variable we discussed <a href=../rc-scripting/#name-var>earlier</a>.
E.g., in this case it will be <code>mumbled_program</code>.
It is <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> that arranges <code>${name}_program</code> to override <code>command</code>.</p></div><div class=paragraph><p>Of course, <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> will permit you to set <code>${name}_program</code> from <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> or the script itself even if <code>command</code> is unset.
In that case, the special properties of <code>${name}_program</code> are lost, and it becomes an ordinary variable your script can use for its own purposes.
However, the sole use of <code>${name}_program</code> is discouraged because using it together with <code>command</code> became an idiom of <span class=filename>rc.d</span> scripting.</p></div></td></tr></tbody></table></div><div class=paragraph><p>For more detailed information on default methods, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>.</p></div></div></div><div class=sect1><h2 id=rcng-daemon-adv>6. Startup and shutdown of an advanced daemon<a class=anchor href=#rcng-daemon-adv></a></h2><div class=sectionbody><div class=paragraph><p>Let us add some meat onto the bones of the previous script and make it more complex and featureful.
The default methods can do a good job for us, but we may need some of their aspects tweaked.
Now we will learn how to tune the default methods to our needs.</p></div><div class="literalblock programlisting"><div class=content><pre>#!/bin/sh

. /etc/rc.subr

name=mumbled
rcvar=mumbled_enable

command=&#34;/usr/sbin/${name}&#34;
command_args=&#34;mock arguments &gt; /dev/null 2&gt;&amp;1&#34; <i class=conum data-value=1></i><b>(1)</b>

pidfile=&#34;/var/run/${name}.pid&#34; <i class=conum data-value=2></i><b>(2)</b>

required_files=&#34;/etc/${name}.conf /usr/share/misc/${name}.rules&#34; <i class=conum data-value=3></i><b>(3)</b>

sig_reload=&#34;USR1&#34; <i class=conum data-value=4></i><b>(4)</b>

start_precmd=&#34;${name}_prestart&#34; <i class=conum data-value=5></i><b>(5)</b>
stop_postcmd=&#34;echo Bye-bye&#34; <i class=conum data-value=6></i><b>(6)</b>

extra_commands=&#34;reload plugh xyzzy&#34; <i class=conum data-value=7></i><b>(7)</b>

plugh_cmd=&#34;mumbled_plugh&#34; <i class=conum data-value=8></i><b>(8)</b>
xyzzy_cmd=&#34;echo &#39;Nothing happens.&#39;&#34;

mumbled_prestart()
{
	if checkyesno mumbled_smart; then <i class=conum data-value=9></i><b>(9)</b>
		rc_flags=&#34;-o smart ${rc_flags}&#34; <i class=conum data-value=10></i><b>(10)</b>
	fi
	case &#34;$mumbled_mode&#34; in
	foo)
		rc_flags=&#34;-frotz ${rc_flags}&#34;
		;;
	bar)
		rc_flags=&#34;-baz ${rc_flags}&#34;
		;;
	*)
		warn &#34;Invalid value for mumbled_mode&#34; <i class=conum data-value=11></i><b>(11)</b>
		return 1 <i class=conum data-value=12></i><b>(12)</b>
		;;
	esac
	run_rc_command xyzzy <i class=conum data-value=13></i><b>(13)</b>
	return 0
}

mumbled_plugh() <i class=conum data-value=14></i><b>(14)</b>
{
	echo &#39;A hollow voice says &#34;plugh&#34;.&#39;
}

load_rc_config $name
run_rc_command &#34;$1&#34;</pre></div></div><div class=paragraph><p>➊ Additional arguments to <code>$command</code> can be passed in <code>command_args</code>.
They will be added to the command line after <code>$mumbled_flags</code>.
Since the final command line is passed to <code>eval</code> for its actual execution, input and output redirections can be specified in <code>command_args</code>.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p><em>Never</em> include dashed options, like <code>-X</code> or <code>--foo</code>, in <code>command_args</code>.
The contents of <code>command_args</code> will appear at the end of the final command line, hence they are likely to follow arguments present in <code>${name}_flags</code>; but most commands will not recognize dashed options after ordinary arguments.
A better way of passing additional options to <code>$command</code> is to add them to the beginning of <code>${name}_flags</code>.
Another way is to modify <code>rc_flags</code> <a href=../rc-scripting/#rc-flags>as shown later</a>.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➋ A good-mannered daemon should create a <em>pidfile</em> so that its process can be found more easily and reliably.
The variable <code>pidfile</code>, if set, tells <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> where it can find the pidfile for its default methods to use.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>In fact, <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> will also use the pidfile to see if the daemon is already running before starting it.
This check can be skipped by using the <code>faststart</code> argument.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➌ If the daemon cannot run unless certain files exist, just list them in <code>required_files</code>, and <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> will check that those files do exist before starting the daemon.
There also are <code>required_dirs</code> and <code>required_vars</code> for directories and environment variables, respectively.
They all are described in detail in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>The default method from <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> can be forced to skip the prerequisite checks by using <code>forcestart</code> as the argument to the script.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➍ We can customize signals to send to the daemon in case they differ from the well-known ones.
In particular, <code>sig_reload</code> specifies the signal that makes the daemon reload its configuration; it is SIGHUP by default.
Another signal is sent to stop the daemon process;
the default is SIGTERM, but this can be changed by setting <code>sig_stop</code> appropriately.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>The signal names should be specified to <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> without the <code>SIG</code> prefix, as it is shown in the example.
The FreeBSD version of <a href="https://man.freebsd.org/cgi/man.cgi?query=kill&amp;sektion=1&amp;format=html">kill(1)</a> can recognize the <code>SIG</code> prefix, but the versions from other OS types may not.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➎➏ Performing additional tasks before or after the default methods is easy.
For each command-argument supported by our script, we can define <code>argument_precmd</code> and <code>argument_postcmd</code>.
These <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> commands are invoked before and after the respective method, as it is evident from their names.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Overriding a default method with a custom <code>argument_cmd</code> still does not prevent us from making use of <code>argument_precmd</code> or <code>argument_postcmd</code> if we need to.
In particular, the former is good for checking custom, sophisticated conditions that should be met before performing the command itself.
Using <code>argument_precmd</code> along with <code>argument_cmd</code> lets us logically separate the checks from the action.</p></div><div class=paragraph><p>Do not forget that you can cram any valid <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> expressions into the methods, pre-, and post-commands you define.
Just invoking a function that makes the real job is a good style in most cases, but never let style limit your understanding of what is going on behind the curtain.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➐ If we would like to implement custom arguments, which can also be thought of as <em>commands</em> to our script, we need to list them in <code>extra_commands</code> and provide methods to handle them.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>The <code>reload</code> command is special. On the one hand, it has a preset method in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>.
On the other hand, <code>reload</code> is not offered by default.
The reason is that not all daemons use the same reload mechanism and some have nothing to reload at all.
So we need to ask explicitly that the builtin functionality be provided.
We can do so via <code>extra_commands</code>.</p></div><div class=paragraph><p>What do we get from the default method for <code>reload</code>? Quite often daemons reload their configuration upon reception of a signal - typically, SIGHUP.
Therefore <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> attempts to reload the daemon by sending a signal to it.
The signal is preset to SIGHUP but can be customized via <code>sig_reload</code> if necessary.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➑⓮ Our script supports two non-standard commands, <code>plugh</code> and <code>xyzzy</code>.
We saw them listed in <code>extra_commands</code>, and now it is time to provide methods for them.
The method for <code>xyzzy</code> is just inlined while that for <code>plugh</code> is implemented as the <code>mumbled_plugh</code> function.</p></div><div class=paragraph><p>Non-standard commands are not invoked during startup or shutdown.
Usually they are for the system admin’s convenience.
They can also be used from other subsystems, e.g., <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a> if specified in <a href="https://man.freebsd.org/cgi/man.cgi?query=devd.conf&amp;sektion=5&amp;format=html">devd.conf(5)</a>.</p></div><div class=paragraph><p>The full list of available commands can be found in the usage line printed by <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> when the script is invoked without arguments.
For example, here is the usage line from the script under study:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># /etc/rc.d/mumbled</span>
Usage: /etc/rc.d/mumbled <span class=o>[</span>fast|force|one]<span class=o>(</span>start|stop|restart|rcvar|reload|plugh|xyzzy|status|poll<span class=o>)</span></code></pre></div></div><div class=paragraph><p>⓭ A script can invoke its own standard or non-standard commands if needed.
This may look similar to calling functions, but we know that commands and shell functions are not always the same thing.
For instance, <code>xyzzy</code> is not implemented as a function here.
In addition, there can be a pre-command and post-command, which should be invoked orderly.
So the proper way for a script to run its own command is by means of <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>, as shown in the example.</p></div><div class=paragraph><p>➒ A handy function named <code>checkyesno</code> is provided by <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>.
It takes a variable name as its argument and returns a zero exit code if and only if the variable is set to <code>YES</code>, or <code>TRUE</code>, or <code>ON</code>, or <code>1</code>, case insensitive;
a non-zero exit code is returned otherwise.
In the latter case, the function tests the variable for being set to <code>NO</code>, <code>FALSE</code>, <code>OFF</code>, or <code>0</code>, case insensitive;
it prints a warning message if the variable contains anything else, i.e., junk.</p></div><div class=paragraph><p>Keep in mind that for <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> a zero exit code means true and a non-zero exit code means false.</p></div><div class="admonitionblock important"><table><tbody><tr><td class=icon><i class="fa icon-important" title=Important></i></td><td class=content><div class=paragraph><p>The <code>checkyesno</code> function takes a <em>variable name</em>.
Do not pass the expanded <em>value</em> of a variable to it; it will not work as expected.</p></div><div class=paragraph><p>The following is the correct usage of <code>checkyesno</code>:</p></div><div class="literalblock programlisting"><div class=content><pre>if checkyesno mumbled_enable; then
        foo
fi</pre></div></div><div class=paragraph><p>On the contrary, calling <code>checkyesno</code> as shown below will not work - at least not as expected:</p></div><div class="literalblock programlisting"><div class=content><pre>if checkyesno &#34;${mumbled_enable}&#34;; then
        foo
fi</pre></div></div></td></tr></tbody></table></div><div class=paragraph><p>➓ <a id=rc-flags></a>We can affect the flags to be passed to <code>$command</code> by modifying <code>rc_flags</code> in <code>$start_precmd</code>.</p></div><div class=paragraph><p>⓫ In certain cases we may need to emit an important message that should go to <code>syslog</code> as well.
This can be done easily with the following <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> functions: <code>debug</code>, <code>info</code>, <code>warn</code>, and <code>err</code>.
The latter function then exits the script with the code specified.</p></div><div class=paragraph><p>⓬ The exit codes from methods and their pre-commands are not just ignored by default.
If <code>argument_precmd</code> returns a non-zero exit code, the main method will not be performed.
In turn, <code>argument_postcmd</code> will not be invoked unless the main method returns a zero exit code.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>However, <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> can be instructed from the command line to ignore those exit codes and invoke all commands anyway by prefixing an argument with <code>force</code>, as in <code>forcestart</code>.</p></div></td></tr></tbody></table></div></div></div><div class=sect1><h2 id=rcng-hookup>7. Connecting a script to the rc.d framework<a class=anchor href=#rcng-hookup></a></h2><div class=sectionbody><div class=paragraph><p>After a script has been written, it needs to be integrated into <span class=filename>rc.d</span>.
The crucial step is to install the script in <span class=filename>/etc/rc.d</span> (for the base system) or <span class=filename>/usr/local/etc/rc.d</span> (for ports).
Both <span class=filename>bsd.prog.mk</span> and <span class=filename>bsd.port.mk</span> provide convenient hooks for that, and usually you do not have to worry about the proper ownership and mode.
System scripts should be installed from <span class=filename>src/libexec/rc/rc.d</span> through the <span class=filename>Makefile</span> found there.
Port scripts can be installed using <code>USE_RC_SUBR</code> as described <a href=https://docs.freebsd.org/en/books/porters-handbook/#rc-scripts>in the Porter’s Handbook</a>.</p></div><div class=paragraph><p>However, we should consider beforehand the place of our script in the system startup sequence.
The service handled by our script is likely to depend on other services.
For instance, a network daemon cannot function without the network interfaces and routing up and running.
Even if a service seems to demand nothing, it can hardly start before the basic filesystems have been checked and mounted.</p></div><div class=paragraph><p>We mentioned <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> already.
Now it is time to have a close look at it.
In a nutshell, <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> takes a set of files, examines their contents, and prints a dependency-ordered list of files from the set to <code>stdout</code>.
The point is to keep dependency information <em>inside</em> the files so that each file can speak for itself only.
A file can specify the following information:</p></div><div class=ulist><ul><li><p>the names of the "conditions" (which means services to us) it <em>provides</em>;</p></li><li><p>the names of the "conditions" it <em>requires</em>;</p></li><li><p>the names of the "conditions" this file should run <em>before</em>;</p></li><li><p>additional <em>keywords</em> that can be used to select a subset from the whole set of files (<a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> can be instructed via options to include or omit the files having particular keywords listed.)</p></li></ul></div><div class=paragraph><p>It is no surprise that <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> can handle only text files with a syntax close to that of <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a>.
That is, special lines understood by <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> look like <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> comments.
The syntax of such special lines is rather rigid to simplify their processing.
See <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> for details.</p></div><div class=paragraph><p>Besides using <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> special lines, a script can insist on its dependency upon another service by just starting it forcibly.
This can be needed when the other service is optional and will not start by itself because the system admin has disabled it mistakenly in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a>.</p></div><div class=paragraph><p>With this general knowledge in mind, let us consider the simple daemon script enhanced with dependency stuff:</p></div><div class="literalblock programlisting"><div class=content><pre>#!/bin/sh

# PROVIDE: mumbled oldmumble <i class=conum data-value=1></i><b>(1)</b>
# REQUIRE: DAEMON cleanvar frotz <i class=conum data-value=2></i><b>(2)</b>
# BEFORE:  LOGIN <i class=conum data-value=3></i><b>(3)</b>
# KEYWORD: nojail shutdown <i class=conum data-value=4></i><b>(4)</b>

. /etc/rc.subr

name=mumbled
rcvar=mumbled_enable

command=&#34;/usr/sbin/${name}&#34;
start_precmd=&#34;${name}_prestart&#34;

mumbled_prestart()
{
	if ! checkyesno frotz_enable &amp;&amp; \
	    ! /etc/rc.d/frotz forcestatus 1&gt;/dev/null 2&gt;&amp;1; then
		force_depend frotz || return 1 <i class=conum data-value=5></i><b>(5)</b>
	fi
	return 0
}

load_rc_config $name
run_rc_command &#34;$1&#34;</pre></div></div><div class=paragraph><p>As before, detailed analysis follows:</p></div><div class=paragraph><p>➊ That line declares the names of "conditions" our script provides.
Now other scripts can record a dependency on our script by those names.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Usually a script specifies a single condition provided.
However, nothing prevents us from listing several conditions there, e.g., for compatibility reasons.</p></div><div class=paragraph><p>In any case, the name of the main, or the only, <code>PROVIDE:</code> condition should be the same as <code>${name}</code>.</p></div></td></tr></tbody></table></div><div class=paragraph><p>➋➌ So our script indicates which "conditions" provided by other scripts it depends on.
According to the lines, our script asks <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> to put it after the script(s) providing <span class=filename>DAEMON</span> and <span class=filename>cleanvar</span>, but before that providing <span class=filename>LOGIN</span>.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>The <code>BEFORE:</code> line should not be abused to work around an incomplete dependency list in the other script.
The appropriate case for using <code>BEFORE:</code> is when the other script does not care about ours, but our script can do its task better if run before the other one.
A typical real-life example is the network interfaces vs. the firewall: While the interfaces do not depend on the firewall in doing their job, the system security will benefit from the firewall being ready before there is any network traffic.</p></div><div class=paragraph><p>Besides conditions corresponding to a single service each, there are meta-conditions and their "placeholder" scripts used to ensure that certain groups of operations are performed before others.
These are denoted by <span class=filename>UPPERCASE</span> names.
Their list and purposes can be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a>.</p></div><div class=paragraph><p>Keep in mind that putting a service name in the <code>REQUIRE:</code> line does not guarantee that the service will actually be running by the time our script starts.
The required service may fail to start or just be disabled in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a>.
Obviously, <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> cannot track such details, and <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> will not do that either.
Consequently, the application started by our script should be able to cope with any required services being unavailable.
In certain cases, we can help it as discussed <a href=../rc-scripting/#forcedep>below</a></p></div></td></tr></tbody></table></div><div class=paragraph><p><a id=keywords></a>➍ As we remember from the above text, <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> keywords can be used to select or leave out some scripts.
Namely any <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> consumer can specify through <code>-k</code> and <code>-s</code> options which keywords are on the "keep list" and "skip list", respectively.
From all the files to be dependency sorted, <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> will pick only those having a keyword from the keep list (unless empty) and not having a keyword from the skip list.</p></div><div class=paragraph><p>In FreeBSD, <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> is used by <span class=filename>/etc/rc</span> and <span class=filename>/etc/rc.shutdown</span>.
These two scripts define the standard list of FreeBSD <span class=filename>rc.d</span> keywords and their meanings as follows:</p></div><div class=dlist><dl><dt class=hdlist1>nojail</dt><dd><p>The service is not for <a href="https://man.freebsd.org/cgi/man.cgi?query=jail&amp;sektion=8&amp;format=html">jail(8)</a> environment.
The automatic startup and shutdown procedures will ignore the script if inside a jail.</p></dd><dt class=hdlist1>nostart</dt><dd><p>The service is to be started manually or not started at all.
The automatic startup procedure will ignore the script.
In conjunction with the <span class=filename>shutdown</span> keyword, this can be used to write scripts that do something only at system shutdown.</p></dd><dt class=hdlist1>shutdown</dt><dd><p>This keyword is to be listed <em>explicitly</em> if the service needs to be stopped before system shutdown.</p></dd></dl></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>When the system is going to shut down, <span class=filename>/etc/rc.shutdown</span> runs.
It assumes that most <span class=filename>rc.d</span> scripts have nothing to do at that time.
Therefore <span class=filename>/etc/rc.shutdown</span> selectively invokes <span class=filename>rc.d</span> scripts with the <span class=filename>shutdown</span> keyword, effectively ignoring the rest of the scripts.
For even faster shutdown, <span class=filename>/etc/rc.shutdown</span> passes the <span class=filename>faststop</span> command to the scripts it runs so that they skip preliminary checks, e.g., the pidfile check.
As dependent services should be stopped before their prerequisites, <span class=filename>/etc/rc.shutdown</span> runs the scripts in reverse dependency order.
If writing a real <span class=filename>rc.d</span> script, you should consider whether it is relevant at system shutdown time.
E.g., if your script does its work in response to the <span class=filename>start</span> command only, then you need not to include this keyword.
However, if your script manages a service, it is probably a good idea to stop it before the system proceeds to the final stage of its shutdown sequence described in <a href="https://man.freebsd.org/cgi/man.cgi?query=halt&amp;sektion=8&amp;format=html">halt(8)</a>.
In particular, a service should be stopped explicitly if it needs considerable time or special actions to shut down cleanly.
A typical example of such a service is a database engine.</p></div></td></tr></tbody></table></div><div class=paragraph><p><a id=forcedep></a>➎ To begin with, <code>force_depend</code> should be used with much care.
It is generally better to revise the hierarchy of configuration variables for your <span class=filename>rc.d</span> scripts if they are interdependent.</p></div><div class=paragraph><p>If you still cannot do without <code>force_depend</code>, the example offers an idiom of how to invoke it conditionally.
In the example, our <code>mumbled</code> daemon requires that another one, <code>frotz</code>, be started in advance.
However, <code>frotz</code> is optional, too; and <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> knows nothing about such details.
Fortunately, our script has access to all <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variables.
If <code>frotz_enable</code> is true, we hope for the best and rely on <span class=filename>rc.d</span> to have started <code>frotz</code>.
Otherwise we forcibly check the status of <code>frotz</code>.
Finally, we enforce our dependency on <code>frotz</code> if it is found to be not running.
A warning message will be emitted by <code>force_depend</code> because it should be invoked only if a misconfiguration has been detected.</p></div></div></div><div class=sect1><h2 id=rcng-args>8. Giving more flexibility to an rc.d script<a class=anchor href=#rcng-args></a></h2><div class=sectionbody><div class=paragraph><p>When invoked during startup or shutdown, an <span class=filename>rc.d</span> script is supposed to act on the entire subsystem it is responsible for.
E.g., <span class=filename>/etc/rc.d/netif</span> should start or stop all network interfaces described by <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a>.
Either task can be uniquely indicated by a single command argument such as <code>start</code> or <code>stop</code>.
Between startup and shutdown, <span class=filename>rc.d</span> scripts help the admin to control the running system, and it is when the need for more flexibility and precision arises.
For instance, the admin may want to add the settings of a new network interface to <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> and then to start it without interfering with the operation of the existing interfaces.
Next time the admin may need to shut down a single network interface.
In the spirit of the command line, the respective <span class=filename>rc.d</span> script calls for an extra argument, the interface name.</p></div><div class=paragraph><p>Fortunately, <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> allows for passing any number of arguments to script’s methods (within the system limits).
Due to that, the changes in the script itself can be minimal.</p></div><div class=paragraph><p>How can <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> gain access to the extra command-line arguments.
Should it just grab them directly? Not by any means.
Firstly, an <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> function has no access to the positional parameters of its caller, but <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> is just a sack of such functions.
Secondly, the good manner of <span class=filename>rc.d</span> dictates that it is for the main script to decide which arguments are to be passed to its methods.</p></div><div class=paragraph><p>So the approach adopted by <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a> is as follows: <code>run_rc_command</code> passes on all its arguments but the first one to the respective method verbatim.
The first, omitted, argument is the name of the method itself: <code>start</code>, <code>stop</code>, etc.
It will be shifted out by <code>run_rc_command</code>, so what is <code>$2</code> in the original command line will be presented as <code>$1</code> to the method, and so on.</p></div><div class=paragraph><p>To illustrate this opportunity, let us modify the primitive dummy script so that its messages depend on the additional arguments supplied.
Here we go:</p></div><div class="literalblock programlisting"><div class=content><pre>#!/bin/sh

. /etc/rc.subr

name=&#34;dummy&#34;
start_cmd=&#34;${name}_start&#34;
stop_cmd=&#34;:&#34;
kiss_cmd=&#34;${name}_kiss&#34;
extra_commands=&#34;kiss&#34;

dummy_start()
{
        if [ $# -gt 0 ]; then <i class=conum data-value=1></i><b>(1)</b>
                echo &#34;Greeting message: $*&#34;
        else
                echo &#34;Nothing started.&#34;
        fi
}

dummy_kiss()
{
        echo -n &#34;A ghost gives you a kiss&#34;
        if [ $# -gt 0 ]; then <i class=conum data-value=2></i><b>(2)</b>
                echo -n &#34; and whispers: $*&#34;
        fi
        case &#34;$*&#34; in
        *[.!?])
                echo
                ;;
        *)
                echo .
                ;;
        esac
}

load_rc_config $name
run_rc_command &#34;$@&#34; <i class=conum data-value=3></i><b>(3)</b></pre></div></div><div class=paragraph><p>What essential changes can we notice in the script?</p></div><div class=paragraph><p>➊ All arguments you type after <code>start</code> can end up as positional parameters to the respective method.
We can use them in any way according to our task, skills, and fancy.
In the current example, we just pass all of them to <a href="https://man.freebsd.org/cgi/man.cgi?query=echo&amp;sektion=1&amp;format=html">echo(1)</a> as one string in the next line - note <code>$*</code> within the double quotes.
Here is how the script can be invoked now:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># /etc/rc.d/dummy start</span>
Nothing started.

<span class=c># /etc/rc.d/dummy start Hello world!</span>
Greeting message: Hello world!</code></pre></div></div><div class=paragraph><p>➋ The same applies to any method our script provides, not only to a standard one.
We have added a custom method named <code>kiss</code>, and it can take advantage of the extra arguments not less than <code>start</code> does. E.g.:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># /etc/rc.d/dummy kiss</span>
A ghost gives you a kiss.

<span class=c># /etc/rc.d/dummy kiss Once I was Etaoin Shrdlu...</span>
A ghost gives you a kiss and whispers: Once I was Etaoin Shrdlu...</code></pre></div></div><div class=paragraph><p>➌ If we want just to pass all extra arguments to any method, we can merely substitute <code>"$@"</code> for <code>"$1"</code> in the last line of our script, where we invoke <code>run_rc_command</code>.</p></div><div class="admonitionblock important"><table><tbody><tr><td class=icon><i class="fa icon-important" title=Important></i></td><td class=content><div class=paragraph><p>An <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> programmer ought to understand the subtle difference between <code>$*</code> and <code>$@</code> as the ways to designate all positional parameters.
For its in-depth discussion, refer to a good handbook on <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> scripting.
<em>Do not</em> use the expressions until you fully understand them because their misuse will result in buggy and insecure scripts.</p></div></td></tr></tbody></table></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Currently <code>run_rc_command</code> may have a bug that prevents it from keeping the original boundaries between arguments.
That is, arguments with embedded whitespace may not be processed correctly.
The bug stems from <code>$*</code> misuse.</p></div></td></tr></tbody></table></div></div></div><div class=sect1><h2 id=rcng-service-jails>9. Making a script ready for Service Jails<a class=anchor href=#rcng-service-jails></a></h2><div class=sectionbody><div class=paragraph><p>Scripts which start a long running service are suitable for service jails, and should come with a suitable service jail configuration.</p></div><div class=paragraph><p>Some examples of scripts which are not suitable to run in a service jail:</p></div><div class=ulist><ul><li><p>any script which in the start command only changes a runtime setting for programs or the kernel,</p></li><li><p>or tries to mount something,</p></li><li><p>or finds and deletes files</p></li></ul></div><div class=paragraph><p>Scripts not suitable to run in a service jail need to prevent the use within service jails.</p></div><div class=paragraph><p>A script with a long running service which needs to do something listed above before the start or after the stop, can either be split-up into two scripts with dependencies, or use the precommand and postcommand parts of the script to perform this action.</p></div><div class=paragraph><p>By default, only the start and stop parts of a script are run within a service jail, the rest is run outside the jail.
As such any setting used in the start/stop parts of the script can not be set from e.g. a precommand.</p></div><div class=paragraph><p>To make a script ready for use with <a href=../../books/handbook/jails/#service-jails>Service Jails</a>, only one more config line needs to be inserted:</p></div><div class="literalblock programlisting"><div class=content><pre>#!/bin/sh

. /etc/rc.subr

name=&#34;dummy&#34;
start_cmd=&#34;${name}_start&#34;
stop_cmd=&#34;:&#34;

: ${dummy_svcj_options:=&#34;&#34;} <i class=conum data-value=1></i><b>(1)</b>

dummy_start()
{
        echo &#34;Nothing started.&#34;
}

load_rc_config $name
run_rc_command &#34;$1&#34;</pre></div></div><div class=paragraph><p>➊ If it makes sense that the script runs in a jail, it must have an overridable service jails configuration.
If it does not need network access or access to any other resource which is restricted in jails, an empty config like displayed is enough.</p></div><div class=paragraph><p>Strictly speaking an empty config is not needed, but it explicitly describes that the script is service jails ready, and that it does not need additional jail permissions.
As such it is highly recommended to add such an empty config in such a case.
The most common option to use is "net_basic", which enables the use of the hosts IPv4 and IPv6 addresses.
All possible options are explained in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a>.</p></div><div class=paragraph><p>If a setting for the start/stop depends on variables from the rc-framework (e.g., set inside <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a>), this needs to be handled by <code>load_rc_config</code> and <code>run_rc_command</code> instead of inside a precommand.</p></div><div class=paragraph><p>If for some reason a script can not be run within a service jail, e.g., because it is not possible to run or it does not make sense to run it in a jail, use the following:</p></div><div class="literalblock programlisting"><div class=content><pre>#!/bin/sh

. /etc/rc.subr

name=&#34;dummy&#34;
start_cmd=&#34;${name}_start&#34;
stop_cmd=&#34;:&#34;

dummy_start()
{
        echo &#34;Nothing started.&#34;
}

load_rc_config $name
dummy_svcj=&#34;NO&#34;		# does not make sense to run in a svcj <i class=conum data-value=1></i><b>(1)</b>
run_rc_command &#34;$1&#34;</pre></div></div><div class=paragraph><p>➊ The disabling needs to happen after the <code>load_rc_config</code> call, else a <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> setting may override it.</p></div></div></div><div class=sect1><h2 id=rcng-instancing>10. Advanced rc-scripting: Instancing<a class=anchor href=#rcng-instancing></a></h2><div class=sectionbody><div class=paragraph><p>Sometimes it is useful to run several instances of a service.
Typically you want to be able to start/stop such instances independently,
and you want to have a separate config file for each instance.
Each instance should be started at boot,
survive updates,
and benefit from updates.</p></div><div class=paragraph><p>Here is an example of a rc script which supports this:</p></div><div class="literalblock programlisting"><div class=content><pre>#!/bin/sh

#
# PROVIDE: dummy
# REQUIRE: NETWORKING SERVERS
# KEYWORD: shutdown
#
# Add these following line to /etc/rc.conf.local or /etc/rc.conf
# to enable this service:
#
# dummy_enable (bool):	Set it to YES to enable dummy on startup.
#			Default: NO
# dummy_user (string):	User account to run with.
#			Default: www
#

. /etc/rc.subr

case $0 in <i class=conum data-value=1></i><b>(1)</b>
/etc/rc*)
	# during boot (shutdown) $0 is /etc/rc (/etc/rc.shutdown),
	# so get the name of the script from $_file
	name=$_file
	;;
*)
	name=$0
	;;
esac

name=${name##*/} <i class=conum data-value=2></i><b>(2)</b>
rcvar=&#34;${name}_enable&#34; <i class=conum data-value=3></i><b>(3)</b>
desc=&#34;Short description of this service&#34;
command=&#34;/usr/local/sbin/dummy&#34;

load_rc_config &#34;$name&#34;

eval &#34;${rcvar}=\${${rcvar}:-&#39;NO&#39;}&#34; <i class=conum data-value=4></i><b>(4)</b>
eval &#34;${name}_svcj_options=\${${name}_svcj_options:-&#39;net_basic&#39;}&#34; <i class=conum data-value=5></i><b>(5)</b>
eval &#34;_dummy_user=\${${name}_user:-&#39;www&#39;}&#34; <i class=conum data-value=6></i><b>(6)</b>

_dummy_configname=/usr/local/etc/${name}.cfg <i class=conum data-value=7></i><b>(7)</b>
pidfile=/var/run/dummy/${name}.pid
required_files ${_dummy_configname}
command_args=&#34;-u ${_dummy_user} -c ${_dummy_configfile} -p ${pidfile}&#34;

run_rc_command &#34;$1&#34;</pre></div></div><div class=paragraph><p>➊ and ➋ make sure to set the name variable to the <a href="https://man.freebsd.org/cgi/man.cgi?query=basename&amp;sektion=1&amp;format=html">basename(1)</a> of the script name.
If the filename is <span class=filename>/usr/local/etc/rc.d/dummy</span>,
name is set to <span class=filename>dummy</span>.
This way changing the filename of the rc script changes automatically the content of the name variable.</p></div><div class=paragraph><p>➌ specifies the variable name which is used in <span class=filename>rc.conf</span> to enable this service based upon the filename of this script.
In this example this resolves to dummy_enable.</p></div><div class=paragraph><p>➍ makes sure the default for the _enable variable is NO.</p></div><div class=paragraph><p>➎ is an example of having some defaults for service specific framework variables,
in this case the service jails options.</p></div><div class=paragraph><p>➏ and ➐ set variables internal to the script (pay attention to the underscore in front of _dummy_user to make it different from dummy_user which can be set in <span class=filename>rc.conf</span>).</p></div><div class=paragraph><p>The part in ➎ is for variables which are not used inside the script itself but in the rc framework.
All the variables which are used as parameters somewhere in the script are assigned to a generic variable like in ➐ to make it more easy to reference them (no need to eval them at each place of use).</p></div><div class=paragraph><p>This script will now behave differently if the start script has a different name.
This allows to create symlinks to it:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># ln -s dummy /usr/local/etc/rc.d/dummy_foo</span>
<span class=c># sysrc dummy_foo_enable=YES</span>
<span class=c># service dummy_foo start</span></code></pre></div></div><div class=paragraph><p>The above creates an instance of the dummy service with the name dummy_foo.
It does not use the config file <span class=filename>/usr/local/etc/dummy.cfg</span> but the config file <span class=filename>/usr/local/etc/dummy_foo.cfg</span> (➐),
and it uses the PID file <span class=filename>/var/run/dummy/dummy_foo.pid</span> instead of <span class=filename>/var/run/dummy/dummy.pid</span>.</p></div><div class=paragraph><p>The services dummy and dummy_foo can be managed independently of each other,
while having the start script update itself on package update (due to the symlink).
This does not update the REQUIRE line,
as such there is no easy way of depending on a specific instance.
To depend upon a specific instance in the startup order a copy needs to be made instead of using a symlink.
This prevents the automatic pick-up of changes to the start script when an update is installed.</p></div></div></div><div class=sect1><h2 id=rcng-furthur>11. Further reading<a class=anchor href=#rcng-furthur></a></h2><div class=sectionbody><div class=paragraph><p><a id=lukem></a><a href=http://www.mewburn.net/luke/papers/rc.d.pdf>The original article by Luke Mewburn</a> offers a general overview of <span class=filename>rc.d</span> and detailed rationale for its design decisions.
It provides insight on the whole <span class=filename>rc.d</span> framework and its place in a modern BSD operating system.</p></div><div class=paragraph><p><a id=manpages></a>The manual pages <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>, and <a href="https://man.freebsd.org/cgi/man.cgi?query=rcorder&amp;sektion=8&amp;format=html">rcorder(8)</a> document the <span class=filename>rc.d</span> components in great detail.
You cannot fully use the <span class=filename>rc.d</span> power without studying the manual pages and referring to them while writing your own scripts.</p></div><div class=paragraph><p>The major source of working, real-life examples is <span class=filename>/etc/rc.d</span> in a live system.
Its contents are easy and pleasant to read because most rough corners are hidden deep in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>.
Keep in mind though that the <span class=filename>/etc/rc.d</span> scripts were not written by angels, so they might suffer from bugs and suboptimal design decisions.
Now you can improve them!</p></div></div></div><hr><div class=last-modified><p><strong>Last modified on</strong>: August 11, 2024 by <a href="https://cgit.freebsd.org/doc/commit/?id=557464e66e" target=_blank>Fernando Apesteguía</a></p></div></div><aside class=toc><div class=toc-content><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#rcng-intro>1. Introduction</a></li><li><a href=#rcng-task>2. Outlining the task</a></li><li><a href=#rcng-dummy>3. A dummy script</a></li><li><a href=#rcng-confdummy>4. A configurable dummy script</a></li><li><a href=#rcng-daemon>5. Startup and shutdown of a simple daemon</a></li><li><a href=#rcng-daemon-adv>6. Startup and shutdown of an advanced daemon</a></li><li><a href=#rcng-hookup>7. Connecting a script to the rc.d framework</a></li><li><a href=#rcng-args>8. Giving more flexibility to an rc.d script</a></li><li><a href=#rcng-service-jails>9. Making a script ready for Service Jails</a></li><li><a href=#rcng-instancing>10. Advanced rc-scripting: Instancing</a></li><li><a href=#rcng-furthur>11. Further reading</a></li></ul></nav><hr><div class=resources><h3>Resources</h3><ul class=contents><li><i class="fa fa-file-pdf-o" aria-hidden=true title="Download PDF"></i><a href=https://download.freebsd.org/doc/en/articles/rc-scripting/rc-scripting_en.pdf>Download PDF</a></li><li><i class="fa fa-pencil-square-o" aria-hidden=true title="Edit this page"></i><a href=https://github.com/freebsd/freebsd-doc/blob/main/documentation/content/en/_index target=_blank>Edit this page</a></li></ul></div></div></aside></main><footer><div class=footer-container><section class=logo-column><img src=https://docs.freebsd.org/images/FreeBSD-colors.svg width=160 height=50 alt="FreeBSD logo"><div class=options-container><div class=language-container><a id=languages href=https://docs.freebsd.org/en/languages><img src=https://docs.freebsd.org/images/language.png class=language-image alt="Choose language">
<span>English</span></a></div><div class=theme-container><select id=theme-chooser><option value=theme-system>System</option><option value=theme-light>Light</option><option value=theme-dark>Dark</option><option value=theme-high-contrast>High contrast</option></select></div></div></section><section class=about-column><h3 class=column-title>About</h3><ul class=column-elements-container><li><a href=https://www.freebsd.org/about/ target=_blank class=column-element>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/ target=_blank class=column-element>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/where/ target=_blank class=column-element>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct target=_blank class=column-element>Code of Conduct</a></li><li><a href=https://www.freebsd.org/security/ target=_blank class=column-element>Security Advisories</a></li></ul></section><section class=documentation-column><h3 class=column-title>Documentation</h3><ul class=column-elements-container><li><a href=/en class=column-element>Documentation portal</a></li><li><a href=https://man.FreeBSD.org target=_blank class=column-element>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank class=column-element>Presentations and papers</a></li><li><a href=https://docs-archive.freebsd.org/doc/ target=_blank class=column-element>Previous versions</a></li><li><a href=https://docs-archive.freebsd.org/44doc/ target=_blank class=column-element>4.4BSD Documents</a></li><li><a href=https://wiki.freebsd.org/ target=_blank class=column-element>Wiki</a></li></ul></section><section class=community-column><h3 class=column-title>Community</h3><ul class=column-elements-container><li><a href=https://docs.freebsd.org/en/articles/contributing class=column-element>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank class=column-element>Community forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank class=column-element>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank class=column-element>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank class=column-element>Bug Tracker</a></li></ul></section><section class=legal-column><h3 class=column-title>Legal</h3><ul class=column-elements-container><li><a href=https://freebsdfoundation.org/donate/ target=_blank class=column-element>Donations</a></li><li><a href=https://www.freebsd.org/copyright/freebsd-license/ target=_blank class=column-element>Licensing</a></li><li><a href=https://www.freebsd.org/privacy/ target=_blank class=column-element>Privacy Policy</a></li><li><a href=https://www.freebsd.org/copyright/ target=_blank class=column-element>Legal notices</a></li></ul></section><section class=copyright-column><p>&copy; 1994-2024 The FreeBSD Project. All rights reserved</p><span>Made with <span class=heart>♥</span> by the FreeBSD Community</span></section></div></footer></body></html>